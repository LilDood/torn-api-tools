<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/purecss@2.1.0/build/pure-min.css" integrity="sha384-yHIFVG6ClnONEA5yB5DJXfW2/KC173DIQrYoZMEtBvGzmf0PKiGyNEqe9N6BNDBH" crossorigin="anonymous">
        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <style>
            body {
                color: #555;
            }
            .content {
                margin: 0 auto;
                padding: 0 2em;
                max-width: 800px;
                margin-bottom: 50px;
                line-height: 1.6em;
            }
            .header {
                margin: 0;
                color: #333;
                text-align: center;
                padding: 2.5em 2em 0;
                border-bottom: 1px solid #eee;
            }
            .header h1 {
                margin: 0.2em 0;
                font-size: 3em;
                font-weight: 300;
            }
            .header h2 {
                font-weight: 300;
                color: #777;
                padding: 0;
                margin-top: 0;
            }
            .content-subhead {
                margin: 50px 0 20px 0;
                font-weight: 300;
                color: #444;
            }
            @media (min-width: 48em) {
                .header,
                .content {
                    padding-left: 2em;
                    padding-right: 2em;
                }
            }
            table {
                border-collapse: collapse;
            }
            td {
                border: solid 1px black;
                padding: 3px;
            }
            span.badge:after {
                border-radius: 4px;
                background-color: gray;
                vertical-align: middle;
                padding: 4px;
                font-size: 10px;
                margin-left: 6px;
            }
            span.badge.api-key-public:after {
                content: "Public";
                background-color: lightgray;
                color: black;
            }
            span.badge.api-key-minimal:after {
                content: "Minimal";
                background-color: green;
                color: white;
            }
            span.badge.api-key-Limited:after {
                content: "Limited";
                background-color: orange;
                color: black;
            }
            span.badge.api-key-full:after {
                content: "Full";
                background-color: red;
                color: white;
            }
        </style>
        <script>
            const LS_API_KEY = "torn_api_Key";
            const LS_FLYER_LAST_FACTION = "flyer_last_faction";

            function getApiKey() {
                return configureApiKey.getValue();
            }

            const accessLevelBadge = {
                view: function(vnode) {
                    return m("span", { class: `badge api-key-${vnode.attrs['level'].toLowerCase().split(' ')[0]}` })
                }
            }

            const accessLevelBadgePublic = m(accessLevelBadge, { level: "public" });
            const accessLevelBadgeMinimal = m(accessLevelBadge, { level: "minimal" });
            const accessLevelBadgeLimited = m(accessLevelBadge, { level: "limited" });
            const accessLevelBadgeFull = m(accessLevelBadge, { level: "full" });

            const configuration = {
                view: function(vnode) {
                    return [m("h2[class=content-subhead]", "Configuration"), vnode.children];
                    return m("article", [m("h2[class=content-subhead]", "Configuration"), vnode.children]);
                }
            }

            const configureApiKey = function() {
                let value = localStorage[LS_API_KEY];
                let content = null;

                function input(event) {
                    value = event.target.value;
                }

                function save() {
                    localStorage[LS_API_KEY] = value;
                }

                async function check() {
                    const data = await m.request({ url: `https://api.torn.com/key/?selections=info&key=${getApiKey()}` });

                    const user = await m.request({ url: `https://api.torn.com/user/?selections=basic&key=${getApiKey()}` });

                    content = m("div", [
                        m("p", ["API Key Access Level", m(accessLevelBadge, { level: data['access_type'] })]),
                        m("p", ["API Key is for ", m("a", { href: `https://www.torn.com/profiles.php?XID=${user.player_id}` }, `${user.name} [${user.player_id}]`)])
                    ]);
                }

                function clear() {
                    content = null;
                }

                return {
                    view: function() {
                        return [m("form[class=pure-form]", [
                            m("label[for=apiKey]", "API Key"),
                            " ",
                            m("input[name=apiKey]", { oninput: input, value: value }),
                            " ",
                            m("button[class=pure-button][type=button]", { onclick: save }, "Save in Browser"),
                            " ",
                            m("button[class=pure-button][type=button]", { onclick: check }, "Check"),
                            " ",
                            m("button[class=pure-button][type=button]", { onclick: clear, class: !!content ? null : "hidden" }, "Clear")
                        ]), content];
                    },
                    getValue: function() {
                        return value;
                    }
                }
            }();

            const listRankedWars = function() {
                let wars = null;
                let content = null;

                async function load() {
                    const data = await m.request(`https://api.torn.com/torn/?selections=rankedwars&key=${getApiKey()}`);
                    wars = Object.keys(data.rankedwars).map(id => {
                        return {
                            id,
                            ...data.rankedwars[id]
                        };
                    });

                    content = m("table.pure-table-horizontal.pure-table-striped", 
                        [m("tr", [m("th", "Faction A"), m("th", "Faction B"), m("th", "Start Time (TCT)"), m("th", "Start Time (Local)"), m("th", "Winner")])].concat( 
                        wars.sort((a, b) => a.war.start - b.war.start).map(war => {
                            const aId = Object.keys(war.factions)[0];
                            const a = {...war.factions[aId]};
                            const bId = Object.keys(war.factions)[1];
                            const b = {...war.factions[bId]};

                            return m("tr", [
                                m("td", m("a", { href: `https://www.torn.com/factions.php?step=profile&ID=${aId}`}, `${a.name} [${aId}]`)),
                                m("td", m("a", { href: `https://www.torn.com/factions.php?step=profile&ID=${bId}`}, `${b.name} [${bId}]`)),
                                m("td", new Date(war.war.start * 1000).toLocaleString([], { timeZone: "UTC"})),
                                m("td", new Date(war.war.start * 1000).toLocaleString()),
                                m("td", war.war.winner ? war.factions[war.war.winner].name : "-")
                            ])
                        }))
                    );
                }

                function clear() {
                    wars = null;
                    content = null;
                }

                return {
                    view: function() {
                        return [
                            m("h2.content-subhead", ["Ranked War List", accessLevelBadgePublic]),
                            m("button.pure-button[type=button]", { onclick: load }, !!wars ? "Refresh" : "Load"),
                            " ",
                            m("button.pure-button[type=button]", { onclick: clear, class: !!content ? null : "hidden" }, "Clear"),
                            m("div", content)
                        ];
                    }
                }
            }();

            const listFactionFlyers = function() {
                let factionId = localStorage[LS_FLYER_LAST_FACTION];
                let members = null;
                let content = null;

                function input(event) {
                    factionId = event.target.value;
                }

                async function load() {
                    localStorage[LS_FLYER_LAST_FACTION] = factionId;
                    const input = document.getElementById("flyer-faction-input");
                    const data = await m.request({ url: `https://api.torn.com/faction/${factionId}?selections=basic&key=${getApiKey()}` });

                    content = [
                        m("h1", `Flyers for ${data.name}`),
                        m("table.pure-table-horizontal.pure-table-striped", [
                            m("tr", [m("th", "Name"), m("th", "Status")]),
                            ...Object.keys(data.members).map(userId => {
                                const user = data.members[userId];
                                
                                if(user.status.state !== "Abroad" && user.status.state !== "Traveling" && user.status.state !== "Hospital") {
                                    return;
                                }else if(user.status.state === "Hospital") {
                                    // Most of these are probably wrong for the "In a XXX Hospital statuses"
                                    // for(let country of ["Hawaiian", "Mexican", "Canadian", "Swiss", "South African", "Chinese", "Japanese", "Cayman Islands", "British", "Argentinian", "UAE"]) {
                                    //     if(user.status.description.includes(country)) {
                                    //         // Add users in foreign hospital
                                    //         table.appendChild(line);
                                    //     }
                                    // }
                                    if(!user.status.description.startsWith("In a")) {
                                        return;
                                    }
                                }

                                return m("tr", [
                                    m("td", m("a", { href: `https://www.torn.com/profiles.php?XID=${userId}` }, `${user.name} [${userId}]`)),
                                    m("td", `${user.status.description}`)
                                ]);
                            })
                        ])
                    ];
                }

                function clear() {
                    members = null;
                    content = null;
                }

                return {
                    view: function() {
                        return [
                            m("h2.content-subhead", ["Faction Flyers", accessLevelBadgePublic]),
                            m("form[class=pure-form]", [
                                m("label[for=flyersFactionId]", "Faction ID"),
                                " ",
                                m("input[name=flyersFactionId]", { oninput: input, value: factionId }),
                                " ",
                                m("button[class=pure-button][type=button]", { onclick: load }, "Load"),
                                " ",
                                m("button[class=pure-button][type=button]", { onclick: clear, class: !!content ? null : "hidden" }, "Clear")
                            ]),
                            content
                        ];
                    }
                }
            }();

            function onReady() {
                const root = document.querySelector("div.content");
                m.mount(root, {
                    view: function() {
                        return [
                            m(configuration, [m(configureApiKey)]),
                            m(listRankedWars),
                            m(listFactionFlyers)
                        ];
                    }
                });
            }

            window.addEventListener("DOMContentLoaded", onReady);
        </script>
    </head>
    <body>
        <div id="main">
            <div class="header">
                <h1>Torn API Tools</h1>
                <h2>By LilDood [70634]</h2>
            </div>
            <div class="content">
                
            </div>
        </div>
    </body>
</html>