<html>
    <head>
        <style>
            table {
                border-collapse: collapse;
            }
            td {
                border: solid 1px black;
                padding: 3px;
            }
        </style>
        <script>
            const LS_API_KEY = "torn_api_Key";
            const LS_FLYER_LAST_FACTION = "flyer_last_faction";
            
            function onSaveClick() {
                const apiKeyInput = document.getElementById("api-key-input");
                localStorage[LS_API_KEY] = apiKeyInput.value;
            }

            function loadRw() {
                const request = new Request(`https://api.torn.com/torn/?selections=rankedwars&key=${localStorage[LS_API_KEY]}`);
                fetch(request).then(async response => {
                    const button = document.getElementById("rw-load").innerText = "Refresh";
                    const container = document.getElementById("rw-container");
                    container.innerHTML = "";

                    const data = await response.json();

                    const table = document.createElement("table");
                    container.appendChild(table);

                    const header = document.createElement("tr");
                    table.appendChild(header);
                    header.innerHTML = "<th>Faction A</th><th>Faction B</th><th>Start Time</th>"
                    
                    for(let warId of Object.keys(data.rankedwars)) {
                        const war = data.rankedwars[warId];
                        const line = document.createElement("tr");
                        table.appendChild(line);

                        const a = war.factions[Object.keys(war.factions)[0]];
                        a.id = Object.keys(war.factions)[0];
                        const b = war.factions[Object.keys(war.factions)[1]];
                        b.id = Object.keys(war.factions)[1];

                        line.innerHTML = `<td><a href="https://www.torn.com/factions.php?step=profile&ID=${a.id}">${a.name}</a></td><td><a href="https://www.torn.com/factions.php?step=profile&ID=${b.id}">${b.name}</a></td><td>${new Date(war.war.start * 1000).toLocaleString()}</td>`;
                    }
                });
            }

            function loadFlyers() {
                const input = document.getElementById("flyer-faction-input");
                const faction_id = input.value;
                localStorage[LS_FLYER_LAST_FACTION] = faction_id;
                const request = new Request(`https://api.torn.com/faction/${faction_id}?selections=basic&key=${localStorage[LS_API_KEY]}`);
                fetch(request).then(async response => {
                    const button = document.getElementById("flyer-load").innerText = "Refresh";
                    const container = document.getElementById("flyer-container");
                    container.innerHTML = "";

                    const data = await response.json();

                    const title = document.createElement("h1");
                    title.innerText = `Flyers for ${data.name}`;
                    container.appendChild(title);

                    const table = document.createElement("table");
                    container.appendChild(table);

                    const header = document.createElement("tr");
                    table.appendChild(header);
                    header.innerHTML = "<th>Name</th><th>Status</th>"
                    
                    for(let userId of Object.keys(data.members)) {
                        const user = data.members[userId];
                        user.id = userId;
                        const line = document.createElement("tr");

                        if(user.status.state === "Abroad" || user.status.state === "Traveling") {
                            table.appendChild(line);
                        }else if(user.status.state === "Hospital") {
                            // Most of these are probably wrong for the "In a XXX Hospital statuses"
                            // for(let country of ["Hawaiian", "Mexican", "Canadian", "Swiss", "South African", "Chinese", "Japanese", "Cayman Islands", "British", "Argentinian", "UAE"]) {
                            //     if(user.status.description.includes(country)) {
                            //         // Add users in foreign hospital
                            //         table.appendChild(line);
                            //     }
                            // }
                            if(user.status.description.startsWith("In a")) {
                                table.appendChild(line);
                            }
                        }

                        line.innerHTML = `<td><a href="https://www.torn.com/profiles.php?XID=${userId}">${user.name}</a></td><td>${user.status.description}</td>`;
                    }
                });
            }

            function onReady() {
                const key = localStorage[LS_API_KEY]
                const apiKeyInput = document.getElementById("api-key-input");
                apiKeyInput.value = key || "";

                const saveButton = document.getElementById("api-key-save-button");
                saveButton.addEventListener("click", onSaveClick);

                const rwButton = document.getElementById("rw-load");
                rwButton.addEventListener("click", loadRw);

                const flyerButton = document.getElementById("flyer-load");
                flyerButton.addEventListener("click", loadFlyers);
                const flyerInput = document.getElementById("flyer-faction-input");
                flyerInput.value = localStorage[LS_FLYER_LAST_FACTION] || "";
            }

            window.addEventListener("DOMContentLoaded", onReady);
        </script>
    </head>
    <body>
        <div>
            <label for="key">API Key</label>
            <input name="key" id="api-key-input"/>
            <button type="button" id="api-key-save-button">Save in Browser</button>
        </div>
        <div>
            <h2>Ranked Wars</h2>
            <button type="button" id="rw-load">Load</button>
            <div id="rw-container">

            </div>
        </div>
        <div>
            <h2>Flyer Tracker</h2>
            <label for="flyer-faction-id">Faction ID</label>
            <input name="flyer-faction-id" id="flyer-faction-input"/>
            <button type="button" id="flyer-load">Load</button>
            <div id="flyer-container">

            </div>
        </div>
    </body>
</html>